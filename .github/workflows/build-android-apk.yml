name: ğŸš€ Build SnapFit AI Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-apk:
    name: ğŸ“± Build Android APK
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: â˜• Setup Java JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: ğŸ”§ Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: ğŸ“š Install Dependencies
      run: |
        npm ci --legacy-peer-deps
        
    - name: ğŸ—ï¸ Prepare Web Assets
      run: |
        # åˆ›å»ºoutç›®å½•å¹¶å¤åˆ¶èµ„æº
        mkdir -p out
        cp -r public/* out/
        
        # ç¡®ä¿index.htmlå­˜åœ¨
        if [ ! -f out/index.html ]; then
          echo "Creating index.html..."
          cat > out/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="zh">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>SnapFit AI</title>
            <style>
                body { 
                    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
                    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                    margin: 0; padding: 20px; min-height: 100vh;
                    display: flex; align-items: center; justify-content: center;
                }
                .container { 
                    background: white; border-radius: 12px; padding: 30px;
                    text-align: center; max-width: 400px; width: 100%;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
                }
                h1 { color: #10b981; margin-bottom: 20px; }
                .btn { 
                    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                    color: white; padding: 12px 24px; border: none;
                    border-radius: 6px; margin: 10px; cursor: pointer;
                    text-decoration: none; display: inline-block;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>ğŸ¥ SnapFit AI</h1>
                <p>æ™ºèƒ½å¥åº·ç®¡ç†åŠ©æ‰‹</p>
                <a href="http://localhost:3000" class="btn">å¯åŠ¨å®Œæ•´åº”ç”¨</a>
                <p style="color: #666; font-size: 14px; margin-top: 20px;">
                    è¿™æ˜¯ç§»åŠ¨ç«¯ç‰ˆæœ¬ã€‚å®Œæ•´åŠŸèƒ½è¯·è®¿é—®Webç‰ˆæœ¬ã€‚
                </p>
            </div>
        </body>
        </html>
        EOF
        fi
        
    - name: ğŸ”„ Sync Capacitor
      run: |
        npx cap sync android
        
    - name: ğŸ› ï¸ Grant Execute Permission
      run: |
        chmod +x android/gradlew
        
    - name: ğŸ“± Build Debug APK
      run: |
        cd android
        ./gradlew assembleDebug --no-daemon --stacktrace
        
    - name: ğŸ“‹ List APK Files
      run: |
        find android -name "*.apk" -type f
        
    - name: ğŸ“¤ Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: snapfit-ai-debug-apk
        path: android/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30
        
    - name: ğŸ“Š APK Info
      run: |
        APK_PATH="android/app/build/outputs/apk/debug/app-debug.apk"
        if [ -f "$APK_PATH" ]; then
          echo "âœ… APKæ„å»ºæˆåŠŸï¼"
          echo "ğŸ“ æ–‡ä»¶è·¯å¾„: $APK_PATH"
          echo "ğŸ“ æ–‡ä»¶å¤§å°: $(du -h "$APK_PATH" | cut -f1)"
          echo "ğŸ”— ä¸‹è½½é“¾æ¥å°†åœ¨Actionsé¡µé¢çš„Artifactsä¸­æä¾›"
        else
          echo "âŒ APKæ–‡ä»¶æœªæ‰¾åˆ°"
          exit 1
        fi

  create-release:
    name: ğŸ‰ Create Release
    needs: build-apk
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ“¥ Download APK
      uses: actions/download-artifact@v4
      with:
        name: snapfit-ai-debug-apk
        path: ./
        
    - name: ğŸ·ï¸ Generate Tag
      id: tag
      run: |
        TAG="v$(date +'%Y.%m.%d')-$(echo $GITHUB_SHA | cut -c1-7)"
        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "Generated tag: $TAG"
        
    - name: ğŸ‰ Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag.outputs.tag }}
        name: "SnapFit AI APK ${{ steps.tag.outputs.tag }}"
        body: |
          ## ğŸ“± SnapFit AI Android APK
          
          ### ğŸ¯ ç‰ˆæœ¬ä¿¡æ¯
          - **æ„å»ºæ—¶é—´**: ${{ github.event.head_commit.timestamp }}
          - **æäº¤**: ${{ github.sha }}
          - **åˆ†æ”¯**: ${{ github.ref_name }}
          
          ### ğŸ“¦ ä¸‹è½½
          - **APKæ–‡ä»¶**: app-debug.apk
          - **åº”ç”¨åç§°**: SnapFit AI
          - **åŒ…å**: com.snapfit.ai
          - **ç‰ˆæœ¬**: 1.0.0
          
          ### ğŸ“± å®‰è£…è¯´æ˜
          1. ä¸‹è½½APKæ–‡ä»¶åˆ°Androidè®¾å¤‡
          2. å¯ç”¨"æœªçŸ¥æ¥æº"åº”ç”¨å®‰è£…
          3. ç‚¹å‡»APKæ–‡ä»¶è¿›è¡Œå®‰è£…
          4. äº«å—æ‚¨çš„å¥åº·ç®¡ç†åº”ç”¨ï¼
          
          ### ğŸ”§ æŠ€æœ¯ä¿¡æ¯
          - **æ¡†æ¶**: Capacitor + Next.js
          - **æœ€å°Androidç‰ˆæœ¬**: API 22 (Android 5.1)
          - **ç›®æ ‡Androidç‰ˆæœ¬**: API 34 (Android 14)
          
          ---
          
          **ğŸ‰ æ„Ÿè°¢ä½¿ç”¨SnapFit AIï¼**
        files: |
          app-debug.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
