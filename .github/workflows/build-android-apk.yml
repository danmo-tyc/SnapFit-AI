name: 🚀 Build SnapFit AI Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build-apk:
    name: 📱 Build Android APK
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout Repository
      uses: actions/checkout@v4
      
    - name: 📦 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ☕ Setup Java JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: 🔧 Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: 📚 Install Dependencies
      run: |
        npm ci --legacy-peer-deps
        
    - name: 🏗️ Prepare Web Assets
      run: |
        # 创建out目录并复制资源
        mkdir -p out
        cp -r public/* out/
        
        # 确保index.html存在
        if [ ! -f out/index.html ]; then
          echo "Creating index.html..."
          cat > out/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="zh">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>SnapFit AI</title>
            <style>
                body { 
                    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
                    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                    margin: 0; padding: 20px; min-height: 100vh;
                    display: flex; align-items: center; justify-content: center;
                }
                .container { 
                    background: white; border-radius: 12px; padding: 30px;
                    text-align: center; max-width: 400px; width: 100%;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
                }
                h1 { color: #10b981; margin-bottom: 20px; }
                .btn { 
                    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                    color: white; padding: 12px 24px; border: none;
                    border-radius: 6px; margin: 10px; cursor: pointer;
                    text-decoration: none; display: inline-block;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>🏥 SnapFit AI</h1>
                <p>智能健康管理助手</p>
                <a href="http://localhost:3000" class="btn">启动完整应用</a>
                <p style="color: #666; font-size: 14px; margin-top: 20px;">
                    这是移动端版本。完整功能请访问Web版本。
                </p>
            </div>
        </body>
        </html>
        EOF
        fi
        
    - name: 🔄 Sync Capacitor
      run: |
        npx cap sync android
        
    - name: 🛠️ Grant Execute Permission
      run: |
        chmod +x android/gradlew
        
    - name: 📱 Build Debug APK
      run: |
        cd android
        ./gradlew assembleDebug --no-daemon --stacktrace
        
    - name: 📋 List APK Files
      run: |
        find android -name "*.apk" -type f
        
    - name: 📤 Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: snapfit-ai-debug-apk
        path: android/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30
        
    - name: 📊 APK Info
      run: |
        APK_PATH="android/app/build/outputs/apk/debug/app-debug.apk"
        if [ -f "$APK_PATH" ]; then
          echo "✅ APK构建成功！"
          echo "📁 文件路径: $APK_PATH"
          echo "📏 文件大小: $(du -h "$APK_PATH" | cut -f1)"
          echo "🔗 下载链接将在Actions页面的Artifacts中提供"
        else
          echo "❌ APK文件未找到"
          exit 1
        fi

  create-release:
    name: 🎉 Create Release
    needs: build-apk
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: 📥 Checkout Repository
      uses: actions/checkout@v4
      
    - name: 📥 Download APK
      uses: actions/download-artifact@v4
      with:
        name: snapfit-ai-debug-apk
        path: ./
        
    - name: 🏷️ Generate Tag
      id: tag
      run: |
        TAG="v$(date +'%Y.%m.%d')-$(echo $GITHUB_SHA | cut -c1-7)"
        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "Generated tag: $TAG"
        
    - name: 🎉 Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag.outputs.tag }}
        name: "SnapFit AI APK ${{ steps.tag.outputs.tag }}"
        body: |
          ## 📱 SnapFit AI Android APK
          
          ### 🎯 版本信息
          - **构建时间**: ${{ github.event.head_commit.timestamp }}
          - **提交**: ${{ github.sha }}
          - **分支**: ${{ github.ref_name }}
          
          ### 📦 下载
          - **APK文件**: app-debug.apk
          - **应用名称**: SnapFit AI
          - **包名**: com.snapfit.ai
          - **版本**: 1.0.0
          
          ### 📱 安装说明
          1. 下载APK文件到Android设备
          2. 启用"未知来源"应用安装
          3. 点击APK文件进行安装
          4. 享受您的健康管理应用！
          
          ### 🔧 技术信息
          - **框架**: Capacitor + Next.js
          - **最小Android版本**: API 22 (Android 5.1)
          - **目标Android版本**: API 34 (Android 14)
          
          ---
          
          **🎉 感谢使用SnapFit AI！**
        files: |
          app-debug.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
