name: ğŸš€ Build SnapFit AI Android APK

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'debug'
        type: choice
        options:
        - debug
        - release

jobs:
  build-apk:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: â˜• Setup Java JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: ğŸ“± Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: ğŸ”§ Install dependencies
      run: npm ci

    - name: ğŸ”¨ Build Next.js application
      run: npm run build

    - name: ğŸ“ Create root index.html
      run: |
        cat > out/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="zh">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>SnapFit AI - æ™ºèƒ½å¥åº·ç®¡ç†</title>
            <meta http-equiv="refresh" content="0; url=./zh/">
            <link rel="canonical" href="./zh/">
            <style>
                body {
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    height: 100vh;
                    margin: 0;
                    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                    color: white;
                }
                .loading {
                    text-align: center;
                }
                .spinner {
                    border: 3px solid rgba(255,255,255,0.3);
                    border-radius: 50%;
                    border-top: 3px solid white;
                    width: 40px;
                    height: 40px;
                    animation: spin 1s linear infinite;
                    margin: 0 auto 20px;
                }
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            </style>
        </head>
        <body>
            <div class="loading">
                <div class="spinner"></div>
                <h2>SnapFit AI</h2>
                <p>æ­£åœ¨åŠ è½½æ™ºèƒ½å¥åº·ç®¡ç†åº”ç”¨...</p>
                <p><a href="./zh/" style="color: white;">å¦‚æœæ²¡æœ‰è‡ªåŠ¨è·³è½¬ï¼Œè¯·ç‚¹å‡»è¿™é‡Œ</a></p>
            </div>
            
            <script>
                window.location.href = './zh/';
            </script>
        </body>
        </html>
        EOF

    - name: ğŸ”„ Sync Capacitor
      run: npx cap sync android

    - name: ğŸ—ï¸ Grant execute permission for gradlew
      run: chmod +x android/gradlew

    - name: ğŸ“± Build Debug APK
      if: ${{ github.event.inputs.build_type == 'debug' || github.event.inputs.build_type == '' }}
      run: |
        cd android
        ./gradlew assembleDebug --no-daemon --max-workers=2

    - name: ğŸ“± Build Release APK
      if: ${{ github.event.inputs.build_type == 'release' }}
      run: |
        cd android
        ./gradlew assembleRelease --no-daemon --max-workers=2

    - name: ğŸ“Š Get APK info
      id: apk_info
      run: |
        if [ "${{ github.event.inputs.build_type }}" = "release" ]; then
          APK_PATH="android/app/build/outputs/apk/release/app-release.apk"
          APK_NAME="SnapFit-AI-release.apk"
        else
          APK_PATH="android/app/build/outputs/apk/debug/app-debug.apk"
          APK_NAME="SnapFit-AI-debug.apk"
        fi
        
        if [ -f "$APK_PATH" ]; then
          APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT
          echo "apk_size=$APK_SIZE" >> $GITHUB_OUTPUT
          echo "âœ… APK æ„å»ºæˆåŠŸ: $APK_NAME ($APK_SIZE)"
        else
          echo "âŒ APK æ–‡ä»¶æœªæ‰¾åˆ°: $APK_PATH"
          exit 1
        fi

    - name: ğŸ“¤ Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.apk_info.outputs.apk_name }}
        path: ${{ steps.apk_info.outputs.apk_path }}
        retention-days: 30



    - name: ğŸ‰ Build Summary
      run: |
        echo "## ğŸ‰ SnapFit AI APK æ„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“± APK ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **æ–‡ä»¶å**: ${{ steps.apk_info.outputs.apk_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **å¤§å°**: ${{ steps.apk_info.outputs.apk_size }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ç±»å‹**: ${{ github.event.inputs.build_type || 'debug' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“¥ ä¸‹è½½æ–¹å¼" >> $GITHUB_STEP_SUMMARY
        echo "1. åœ¨ Actions é¡µé¢çš„ Artifacts éƒ¨åˆ†ä¸‹è½½" >> $GITHUB_STEP_SUMMARY
        echo "2. æˆ–ç­‰å¾… Release è‡ªåŠ¨å‘å¸ƒ (å¦‚æœæ˜¯ tag æ¨é€)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸš€ åŠŸèƒ½ç‰¹æ€§" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… å¥åº·æ•°æ®ç®¡ç†" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… AI æ™ºèƒ½åˆ†æ" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… æ•°æ®å¯è§†åŒ–" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… åŒè¯­æ”¯æŒ" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ç¦»çº¿å­˜å‚¨" >> $GITHUB_STEP_SUMMARY
